name: Terraform Replace
permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      replace_resource:
        description: 'Resource address to recreate (e.g. module.vpc.aws_instance.web)'
        required: true
        default: ''
      deployment_name:
        description: "Deployment name (e.g. home-lab, frontends, plex, etc)"
        required: true
        default: ''
      environment:
        description: "Hashicorp workspace tag for resource's state"
        required: true
        default: ''
env:
  PROXMOX_VE_API_TOKEN: ${{ secrets.PROXMOX_VE_API_TOKEN }}

jobs:
  terraform-replace:
    runs-on: self-hosted
    environment: ${{ inputs.environment }}
    env:
        TF_WORKSPACE: ${{ inputs.environment }}
        NODE_OPTIONS: "--no-network-family-autoselection"

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'

    - name: Set up Terraform
      uses: hashicorp/setup-terraform@v3.1.2
      with:
        cli_config_credentials_token: ${{ secrets.HCP_API_TOKEN }}

    - name: Terraform Init
      working-directory: terraform/deployments/${{ inputs.deployment_name }}
      run: terraform init -input=false

    - name: Terraform Validate
      working-directory: terraform/deployments/${{ inputs.deployment_name }}
      run: terraform validate

    - name: Terraform Apply
      working-directory: terraform/deployments/${{ inputs.deployment_name }}
      run: |
        # Construct the replace flag if an input was provided
        REPLACE_FLAG=""
        if [ -n "${{ github.event.inputs.replace_resource }}" ]; then
          REPLACE_FLAG="-replace=${{ github.event.inputs.replace_resource }}"
        fi

        terraform apply -auto-approve $REPLACE_FLAG
